# Event Framework

The purpose of the Event Framework is to provide a standard unified architecture to capture all Mojaloop events.


## 1. Requirements

- Events will be produced by utilising a standard common library that will publish events to a sidecar component utilising a light-weight highly performant protocol (e.g. gRPC).
- Sidecar module will publish events to a singular Kafka topic that will allow for multiple handlers to consume and process the events as required.
- Kafka partitions will be determined by the event-type (e.g. log, audit, trace, errors etc).
- Each Mojaloop component will have its own tightly coupled Sidecar.


## 2. Architecture

### 2.1 Overview

![Event Framework Architecture](./assets/diagrams/architecture/architecture-event-framework.svg)


### 2.2 Micro Service Pods

![Pod Architecture](./assets/diagrams/architecture/architecture-event-sidecar.svg) 

### 2.3 Tracing 

![Tracing Architecture](./assets/diagrams/architecture/architecture-event-trace.svg)

## 3. Event Envelope Model

## 3.1 JSON Example
```JSON
{
    "from": "noresponsepayeefsp",
    "to": "payerfsp",
    "id": "aa398930-f210-4dcd-8af0-7c769cea1660",
    "content": {
        "headers": {
            "content-type": "application/vnd.interoperability.transfers+json;version=1.0",
            "date": "2019-05-28T16:34:41.000Z",
            "fspiop-source": "noresponsepayeefsp",
            "fspiop-destination": "payerfsp"
        },
        "payload": "data:application/vnd.interoperability.transfers+json;version=1.0;base64,ewogICJmdWxmaWxtZW50IjogIlVObEo5OGhaVFlfZHN3MGNBcXc0aV9VTjN2NHV0dDdDWkZCNHlmTGJWRkEiLAogICJjb21wbGV0ZWRUaW1lc3RhbXAiOiAiMjAxOS0wNS0yOVQyMzoxODozMi44NTZaIiwKICAidHJhbnNmZXJTdGF0ZSI6ICJDT01NSVRURUQiCn0"
    },
    "type": "application/json",
    "metadata": {
        "event": {
            "id": "3920382d-f78c-4023-adf9-0d7a4a2a3a2f",
            "type": "position",
            "action": "commit",
            "createdAt": "2019-05-29T23:18:32.935Z",
            "state": {
                "status": "success",
                "code": 0,
                "description": "action successful"
            },
            "responseTo": "1a396c07-47ab-4d68-a7a0-7a1ea36f0012"
        },
        "trace": {
            "traceId": "bbd7b2c7-3978-408e-ae2e-a13012c47739",
            "parentId": "4e3ce424-d611-417b-a7b3-44ba9bbc5840",
            "spanId": "efeb5c22-689b-4d04-ac5a-2aa9cd0a7e87",
        }
    }
}
```

## 3.2 JSON Schema Definition
```JSON
TBD
```

### 3.2.1 Object Definition: MessageType 

| Name | Type | Description | Example |
| --- | --- | --- | --- |
| id | string | Mandatory. The id references the related message. |  |
| from | string | Optional. If the value is not present in the destination, it means that the notification was generated by the connected node (server). |  |
| to | string | Mandatory for the sender and optional in the destination. The sender can ommit the value of the domain. | |
| pp | string | Optional for the sender, when is considered the identity of the session. Is mandatory in the destination if the identity of the originator is different of the identity of the from property. | |
| metadata | object \<metadataType\> | Optional. The sender should avoid to use this property to transport any kind of content-related information, but merely data relevant to the context of the communication. Consider to define a new content type if there's a need to include more content information into the message. | |
| type | string | `MIME` declaration of the content type of the message. | |
| content | object \<any\> | The representation of the content. | |


##### 3.2.1.1 Object Definition: ObMetadataType 

| Name | Type | Description | Example |
| --- | --- | --- | --- |
| event | object \<ObEventType\> | Mandatory. Event information. |  |
| trace | object \<ObTraceType\> | Mandatory. Trace information. |  |

##### 3.2.1.2 Object Definition: ObEventType 

| Name | Type | Description | Example |
| --- | --- | --- | --- |
| id | string | Mandatory. UUIDv4 for event. | 3920382d-f78c-4023-adf9-0d7a4a2a3a2f |
| type | enum \<EnEventType\> | Mandatory. Type of event. | [`log`, `audit`, `error` `trace`] |
| action | enum \<EnEventTypeAction\> | Mandatory. Type of action. | [ `start`, `end` ] |
| state | string \<ObStateType\> | Mandatory. Object describing the state. |  |
| createdAt | timestamp | Mandatory. ISO Timestamp. | 2019-05-29T23:18:32.935Z |

##### 3.2.1.3 Object Definition: ObStateType 

| Name | Type | Description | Example |
| --- | --- | --- | --- |
| status | enum \<EneventStatus\> | Mandatory. The id references the related message. | success |
| code | string | Optional. The error code as per Mojaloop specification. | 2000 |
| description | string | Optional. Description for the status. Normally used to include an description for an error. | Generic server error to be used in order not to disclose information that may be considered private. |

##### 3.2.1.4 Object Definition: ObTraceType

| Name | Type | Description | Example |
| --- | --- | --- | --- |
| traceId | string | Mandatory. The end-to-end transaction identifier. | 80f198ee56343ba864fe8b2a57d3eff7 |
| spanId | string | Mandatory. Id for a processing leg identifier for a component or function. | 05e3ac9a4f6e3b90 |
| parentSpanId | string | Optional. The id references the related message. | e457b5a2e4d86bd1 |
| sampled | number | Optional. Indicator if event message should be included in the trace `1`. If excluded it will be left the consumer to decide on sampling. | 1 |
| flags | number | Optional. Indicator if event message should be included in the trace flow. ( Debug `1` - this will override the sampled value ) | 0 |

##### 3.2.1.5 Enum: EnEventType

| Enum | Description | EnEventTypeAction |
| --- | --- | --- |
| log | Event representing a general log entry. | [ `info`, `debug`, `verbose`, `perf` ] |
| audit | Event to be signed and persisted into the audit store. | [ --- ] |
| trace | Event containing trace context information to be persisted into the tracing store. | [ `start`, `end` ] |
| error | Event representing an error. | [ `internal`, `external` ] |

##### 3.2.1.6 Enum: EnEventStatus

| Enum | Description | 
| --- | --- |
| success | Event was processed successfully |
| failed | Event was processed with a failure or error |


## 4. Tracing Design

### 4.1 HTTP Transports

Current standard HTTP Transport headers for tracing. Mojaloop has yet to standardise on either standard, or if it will possible support both.

#### 4.1.1 WC3 Http Headers

Refer to the following publication for more information: https://w3c.github.io/trace-context/ 

| Header | Description | Example |
| --- | --- | --- |
| traceparent | Dash delimited string of tracing information: \<version\>-\<trace-id\>-\<parent\/span-id\>-\<trace-flags\> | 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00 |
| tracestate | Comma delimited vendor specific format captured as follows: \<vendor\>=\<base64-encoded-state\>| congo=t61rcWkgMzE,rojo=00f067aa0ba902b7 |

Note: Before this specification was written, some tracers propagated X-B3-Sampled as true or false as opposed to 1 or 0. While you shouldn't encode X-B3-Sampled as true or false, a lenient implementation may accept them.

#### 4.1.2 B3 HTTP Headers

Refer to the following publication for more information: https://github.com/apache/incubator-zipkin-b3-propagation

| Header | Description | Example |
| --- | --- | --- |
| X-B3-TraceId | Encoded as 32 or 16 lower-hex characters. | a 128-bit TraceId header might look like: X-B3-TraceId: 463ac35c9f6413ad48485a3953bb6124. Unless propagating only the Sampling State, the X-B3-TraceId header is required. |
| X-B3-SpanId | Encoded as 16 lower-hex characters. | a SpanId header might look like: X-B3-SpanId: a2fb4a1d1a96d312. Unless propagating only the Sampling State, the X-B3-SpanId header is required. |
| X-B3-ParentSpanId | header may be present on a child span and must be absent on the root span. It is encoded as 16 lower-hex characters. | A ParentSpanId header might look like: X-B3-ParentSpanId: 0020000000000001 |
| X-B3-Sampled | An accept sampling decision is encoded as `1` and a deny as `0`. Absent means defer the decision to the receiver of this header. | A Sampled header might look like: X-B3-Sampled: 1. |
| X-B3-Flags | Debug is encoded as `1`. Debug implies an accept decision, so don't also send the X-B3-Sampled header. | |


### 4.2 Known limitations

- Transfer tracing would be limited to each of the transfer legs (i.e. Prepare and Fulfil) as a result of the Mojaloop API specification not catering for tracing information. The trace information will be send as part of the callbacks by the Switch, but the FSPs will not be required to respond appropriately with a reciprocal trace headers.
